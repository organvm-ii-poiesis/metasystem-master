name: Art → Commerce

# Edge 2 (II→III): When an issue is labeled 'ready-for-commercialization',
# checks gates and dispatches art.ready-commercialize to ORGAN-IV.

on:
  issues:
    types: [labeled]

jobs:
  dispatch-commercialize:
    if: github.event.label.name == 'ready-for-commercialization'
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - name: Validate gates
        id: gates
        env:
          GH_TOKEN: ${{ secrets.ORCHESTRATION_PAT || secrets.GITHUB_TOKEN }}
          REPO_FULL: ${{ github.repository }}
          ISSUE_NUM: ${{ github.event.issue.number }}
        run: |
          # Gate 1: documentation-complete label
          LABELS=$(gh issue view "$ISSUE_NUM" --repo "$REPO_FULL" --json labels --jq '.labels[].name' 2>/dev/null || echo "")
          DOC_OK=$(echo "$LABELS" | grep -c "documentation-complete" || true)

          # Gate 2: security-review label
          SEC_OK=$(echo "$LABELS" | grep -c "security-review" || true)

          echo "documentation-complete: $DOC_OK"
          echo "security-review: $SEC_OK"

          if [ "$DOC_OK" -ge 1 ] && [ "$SEC_OK" -ge 1 ]; then
            echo "gates_passed=true" >> "$GITHUB_OUTPUT"
          else
            echo "gates_passed=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Check for existing tracking issue
        if: steps.gates.outputs.gates_passed == 'true'
        id: check
        env:
          GH_TOKEN: ${{ secrets.ORCHESTRATION_PAT || secrets.GITHUB_TOKEN }}
          REPO_FULL: ${{ github.repository }}
        run: |
          EXISTING=$(gh issue list \
            --repo organvm-iv-taxis/orchestration-start-here \
            --search "Promotion: ${REPO_FULL} in:title" \
            --state open --json title --limit 3 2>/dev/null || echo "[]")
          COUNT=$(echo "$EXISTING" | python3 -c "import sys,json; print(len([i for i in json.load(sys.stdin) if 'Promotion:' in i.get('title','')]))" 2>/dev/null || echo "0")
          if [ "$COUNT" -gt 0 ]; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Dispatch art.ready-commercialize
        if: steps.gates.outputs.gates_passed == 'true' && steps.check.outputs.exists == 'false'
        env:
          GH_TOKEN: ${{ secrets.ORCHESTRATION_PAT || secrets.GITHUB_TOKEN }}
          REPO_FULL: ${{ github.repository }}
          ISSUE_NUM: ${{ github.event.issue.number }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
        run: |
          PAYLOAD=$(python3 -c "
          import json, os
          print(json.dumps({
              'source_repo': os.environ['REPO_FULL'],
              'source_organ': 'ORGAN-II',
              'target_organ': 'ORGAN-III',
              'promotion_type': 'promote-to-commerce',
              'issue_number': os.environ['ISSUE_NUM'],
              'issue_title': os.environ['ISSUE_TITLE'],
              'triggered_by': 'art-to-commerce',
          }))
          ")

          gh api repos/organvm-iv-taxis/orchestration-start-here/dispatches \
            --method POST \
            -f event_type=art.ready-commercialize \
            -f "client_payload=${PAYLOAD}"

          echo "Dispatched art.ready-commercialize for ${REPO_FULL}"

      - name: Comment gate failure
        if: steps.gates.outputs.gates_passed == 'false'
        uses: actions/github-script@v8
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `**Commercialization blocked.**\n\nRequired labels missing:\n- \`documentation-complete\`\n- \`security-review\`\n\nAdd both labels and re-apply \`ready-for-commercialization\` to retry.\n\n---\n*Generated by art-to-commerce workflow*`
            });
